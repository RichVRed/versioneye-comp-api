require 'spec_helper'

describe Versioneye::VulnerabilitiesApi, :type => :request do

  let( :vulnerability_uri ) { "/api/v2/vulnerabilities" }
  let( :test_user   ) { UserFactory.create_new(91) }
  let( :user_api    ) { ApiFactory.create_new test_user }

  def encode_prod_key(prod_key)
    prod_key.gsub("/", ":")
  end

  describe "GET detailed info for specific vulnerability" do

    it "returns the correct product" do
      sv = SecurityVulnerability.new({
        :name_id => 'test',
        :language => "Java",
        :prod_key => "junit/junit",
        :cve => 'cve-1111',
        :source => "test",
        :affected_versions => ["1.0.0", "1.1.1"]
      })
      expect( sv.save ).to be_truthy

      package_url =  "#{vulnerability_uri}/#{sv.ids}?api_key=#{user_api.api_key}"
      get package_url
      expect( response.status ).to eql(200)
      json = JSON.parse response.body
      expect( json["components"].count ).to eq(2)
      expect( json["source"]["vendor"] ).to eq('test')
      expect( json["properties"]["cve"] ).to eq('cve-1111')
    end

  end

end
